{% extends "base.html" %}
{% load formatted_tags %}

{% load static %}
{% load django_bootstrap5 %}
{% block title %}
  {% if '/edit/' in request.path %}
    Редактирование
  {% elif "/delete/" in request.path %}
    Удаление
  {% else %}
    Добавление
  {% endif %}
{% endblock %}
{% block content %}
    <style>
      .not-visible{display: none;}
    </style>
  <div class="col d-flex justify-content-center">
    {% comment %} <div class="card" style="width: 100rem;"> {% endcomment %}
    {% comment %} <div class="card" style="width: 100rem;">
      <div class="card-header"> {% endcomment %}
        {% if '/edit/' in request.path %}
        <div class="card" style="width: 100rem;">
          <div class="card-header">
          Редактирование
        {% elif '/delete/' in request.path %}
        <div class="card" style="width: 20rem;">
          <div class="card-header">
          Удаление
        {% else %}
        <div class="card" style="width: 100rem;">
          <div class="card-header">
          Добавление
        {% endif %}
      </div>



          {% if '/delete/' in request.path %}
          {% comment %} <div class="card-body"> {% endcomment %}
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% bootstrap_form form %}
            <div>
              <p>
                Подтвердите, пожалуйста, удаление переменной: 
              </p>
            <p>
              <b>Контроллер:</b> &nbsp; {{ object.n_controller.c_desc_controller }}
            </p>
            <p>
              <b>Имя:</b> &nbsp; {{ object.c_name_variable }} 
            </p>
            <p>
              <b>Описание:</b> &nbsp; {{ object.c_desc_variable }}
            </p>

            </div>
            <br>
          {% else %}
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {% include 'variables/navigation.html' %}
 
            <div class="row row-cols-1 row-cols-md-3 g-4">
              {% for item_key, item_values in form.base_fields_by_group.items %}
                <div class="col">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">{{ item_key }}</h5>
                      {% comment %} <p class="card-text">Данные, используемые в системе. Обязательны для заполнения.</p> {% endcomment %}
                      <ul class="list-group list-group-flush">
                        <li class="list-group-item list-group-item-secondary" aria-disabled="true"></li>
                        {% for item in item_values %}

                        {% for item_base_fields_key, item_base_fields_values in form.base_fields.items %}
                        
                          {% if item_base_fields_key == item %}
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                            {% if item_base_fields_key == 'n_module_id' or item_base_fields_key == 'n_controller' %}
                            {% comment %} {{ item_base_fields_values.label }}:&nbsp<select id="id_{{ item_base_fields_key }}" name={{ item_base_fields_key }} class="form-select selcls" arial-label="Default select" size="sm" style="padding: 0px 5px"> {% endcomment %}
                            {{ item_base_fields_values.label }}:&nbsp<select name={{ item_base_fields_key }} class="form-select selcls" arial-label="Default select" size="sm" style="padding: 0px 5px">
                                {% comment %} <option value="select_item" selected>Не выбран</option> {% endcomment %}
                                <option value="" {% if item_base_fields_values.initial == None %}selected{%endif%}>Не выбран</option>                                

                                
                                {% if item_base_fields_key == 'n_module_id' %}
                                  {% for item_module in form.list_modules %}
                                    <option value={{ item_module.id }} {% if item_base_fields_values.initial == item_module.id %}selected{%endif%}>{{ item_module.c_name_module }}</option>
                                  {% endfor %}
                                {% else %}
                                  {% for item_plc in form.list_plc %}
                                    <option value={{ item_plc.id }} {% if item_base_fields_values.initial == item_plc.id %}selected{%endif%}>{{ item_plc.c_name_controller }}</option>
                                  {% endfor %} 
                                {% endif %}
                              </select>
                            {% elif item_base_fields_key == 'n_variable_type' %}
                              {{ item_base_fields_values.label }}:&nbsp<select class="form-select selcls" name={{ item_base_fields_key }} arial-label="Default select" size="sm" style="padding: 0px 5px">
                                {% comment %} <option value="select_item" selected>Не выбран</option> {% endcomment %}
                                <option value="select_item" {% if item_base_fields_values.initial == None %}selected{%endif%}>Не выбран</option>                                
                                  {% for item_type in form.variable_types %}
                                    <option value={{ item_type.id }} {% if item_base_fields_values.initial == item_type.id %}selected{%endif%}>{{ item_type.c_type_desc }}</option>
                                  {% endfor %}
                              </select>

                            {% elif item_base_fields_key == 'n_variable_data_type' %}
                              {{ item_base_fields_values.label }}:&nbsp<select class="form-select selcls" name={{ item_base_fields_key }} arial-label="Default select" size="sm" style="padding: 0px 5px">
                                <option value="select_item" {% if item_base_fields_values.initial == None %}selected{%endif%}>Не выбран</option>                                
                                {% comment %} <option value="select_item" selected>Не выбран</option> {% endcomment %}
                                  {% for item_data_type in form.variable_data_types %}
                                    <option value={{ item_data_type.id }} {% if item_base_fields_values.initial == item_data_type.id %}selected{%endif%}>{{ item_data_type.c_type_desc }}</option>
                                  {% endfor %}
                              </select>
                            {% elif item_base_fields_key == 'b_masked' %}
                            {{ item_base_fields_values.label}}:<input name={{ item_base_fields_key }} type={{ item_base_fields_values.widget.input_type }} class="form-check-label" {% if item_base_fields_values.initial == True %}checked{%endif%}/>
                            {% else %}
                                {{ item_base_fields_values.label }}:&nbsp
                                {% comment %} <input name={{ item_base_fields_key }} type={{ item_base_fields_values.widget.input_type }} class="form-control" placeholder="" value="{% if item_base_fields_values.initial != None %}{{item_base_fields_values.initial}}{%else%}{%endif%}" {% if item_base_fields_key == 'n_variable_index' and not form.OBJ_NEW %}disabled{%else%}{%endif%}/> {% endcomment %}
                                {% comment %} <input name={{ item_base_fields_key }} type={{ item_base_fields_values.widget.input_type }} class="form-control" placeholder="" value="{% if item_base_fields_values.initial != None %}{{item_base_fields_values.initial}}{%else%}{%endif%}"/>                                 {% endcomment %}
                                <input name={{ item_base_fields_key }} type={{ item_base_fields_values.widget.input_type }} class="form-control" placeholder="" value="{% if item_base_fields_values.initial != None %}{{item_base_fields_values.initial}}{%else%}{%endif%}" {% if item_base_fields_key == 'n_variable_index' and not form.OBJ_NEW %}readonly="readonly"{%else%}{%endif%}/>
                            {% endif %}
                          {% endif %}
                        </li>
                        {% endfor %}

                      {% endfor %}
                        
                    </ul>              
                    </div>
                  </div>
                </div>
              {% endfor %}
              {% comment %}============================================== {% endcomment %}
              {% for key, values in form.attr_fields_by_group.items %}
                <div class="col">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">{{ key }}</h5>
                      {% comment %} <p class="card-text">Данные, используемые в системе. Обязательны для заполнения.</p> {% endcomment %}
                      <ul class="list-group list-group-flush">
                            <li class="list-group-item list-group-item-secondary" aria-disabled="true"></li>
                      {% for item in values %}
                      {% if item.n_attribute_type == 128 or item.n_attribute_type == 130 %}
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ item.c_display_attribute}}:
                            {% if item.n_attribute_type == 128 %}
                              <input name=attr_{{item.c_name_attribute}} type={% if item.n_attribute_type == 128 or item.n_attribute_type == 130%}"number"{%else%}"text"{%endif%} class="form-control" placeholder="" step="1" value={% if item.initial != None %}{{item.initial|formatted_int}}{%else%}0{%endif%} />
                            {% elif item.n_attribute_type == 130 %}
                              <input name=attrf_{{item.c_name_attribute}} type={% if item.n_attribute_type == 128 or item.n_attribute_type == 130%}"number"{%else%}"text"{%endif%} class="form-control" placeholder="" step="any" value={% if item.initial != None %}{{item.initial|formatted_float}}{%else%}0.0{%endif%} />
                            {% endif %}
                          </li>

                      {% elif item.n_attribute_type == 129 %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          <label class="form-check-label" >
                          {% comment %} <label class="form-check-label" for=attrb_0{{ item.n_parameter_bit }}{{ item.c_name_attribute }} > {% endcomment %}
                            {% if item.n_parameter_bit < 10 %}
                              <input type="checkbox" name=attrb_0{{ item.n_parameter_bit }}{{ item.c_name_attribute }} id=id_attrb_0{{ item.n_parameter_bit }}{{ item.c_name_attribute }} class="form-check-input" {% if item.initial == True %}checked{%endif%}/> &nbsp &nbsp {{ item.c_display_attribute }}                     
                            {% else %}
                              <input type="checkbox" name=attrb_{{ item.n_parameter_bit }}{{ item.c_name_attribute }} id=id_attrb_{{ item.n_parameter_bit }}{{ item.c_name_attribute }} class="form-check-input"  {% if item.initial == True %}checked{%endif%}/> &nbsp &nbsp {{ item.c_display_attribute }}
                            {%endif%}
                          </label> 
                        </li>
                      {% elif item.n_attribute_type == 134 %}
                        <div id='control_buttons'>
                        </div>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          <label class="form-check-label" >
                          {% comment %} <label class="form-check-label" for=attrb_0{{ item.n_parameter_bit }}{{ item.c_name_attribute }} > {% endcomment %}
                            {% comment %} <input name=attrtxt_{{item.c_name_attribute}} type="text" class="form-control" placeholder="" value={% if item.initial != None %}{{item.initial}}{%else%}{%endif%} /> {% endcomment %}
                            <textarea cols="40" name=attrtxt_{{item.c_name_attribute}} id=id_attrtxt_{{item.c_name_attribute}} rows="10" >{% if item.initial != None %}{{item.initial}}{%else%}{%endif%}</textarea>                            
                          </label> 
                        </li>
                      {% endif %}

                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
                {% endfor %}
              {% comment %}============================================== {% endcomment %}
            </div>

          {% endif %}

          {% comment %} {% if '/edit/' in request.path or '/create/' in request.path%}
            {% if '/edit/' in request.path %}
              <div>
               <button type="button" class="btn btn-outline-primary"><a class="text-decoration-none text-reset"
                href="{% url 'variables:variable_edit' object.n_controller_id form.MOVEMENT_ID.prev %}">Предыдущий</a></button>

                <button type="button" class="btn btn-outline-primary"><a class="text-decoration-none text-reset"
                href="{% url 'variables:variable_edit' object.n_controller_id form.MOVEMENT_ID.next %}">Следующий</a></button>

                {% url 'variables:variable_by_plc' object.n_controller_id as cancel_url %}
                {% bootstrap_button button_type="link" href=cancel_url content="Отмена" %}
              </div>
              <br>
            {% endif %}
            {% bootstrap_button button_type="submit" content="Сохранить в БД" %}
            <input name="download_to_plc" type="checkbox" class="form-check-label" />Сохранить в ПЛК
            {% if '/edit/' not in request.path %}

            {% url 'variables:variable_by_plc' object.n_controller_id as cancel_url %}
            {% bootstrap_button button_type="link" href=cancel_url content="Отмена" %}
            {% endif %}
          {% elif '/delete/' in request.path %}
           {% bootstrap_button button_type="submit" content="Удалить" %}

           {% url 'variables:variable_by_plc' object.n_controller_id as cancel_url %}
           {% bootstrap_button button_type="link" href=cancel_url content="Отмена" %}
          {% endif %}

          {% if '/edit/' in request.path %}

           <div>
            <br>
           <button type="button" class="btn btn-outline-primary" id="btn_upload">Получить из ПЛК</button>

           <button type="button" class="btn btn-outline-primary" id="view_detail">V</button> 

           </div>
           

          {% endif %} {% endcomment %}
          <br>
          {% if '/edit/' in request.path or '/create/' in request.path%}
          {% if '/edit/' in request.path %}
      
              <button type="button" class="btn btn-outline-primary"><a class="text-decoration-none text-reset"
              href="{% url 'variables:variable_edit' object.n_controller_id form.MOVEMENT_ID.prev %}"> << </a></button>                
              <input name="variable_index_below" id="variable_index_below_id" style="width: 40px;text-align: center" type="text" value= {{ object.n_variable_index }} >
              <button type="button" class="btn btn-outline-primary"><a class="text-decoration-none text-reset"
                  href="{% url 'variables:variable_edit' object.n_controller_id form.MOVEMENT_ID.next %}"> >> </a></button>
                  {% url 'variables:variable_by_plc' object.n_controller_id as cancel_url %}
                  {% bootstrap_button button_type="link" href=cancel_url content="Отмена" %}
      
          {% endif %}
          {% bootstrap_button button_type="submit" content="Сохранить в БД" %}
          <input name="download_to_plc" type="checkbox" style="width: 20px;height: 20px;" class="form-check-label" /> Сохранить в ПЛК
          {% if '/edit/' not in request.path %}
              {% url 'variables:variable_by_plc' object.n_controller_id as cancel_url %}
              {% bootstrap_button button_type="link" href=cancel_url content="Отмена" %}
          {% endif %}
      
      {% elif '/delete/' in request.path %}
          {% bootstrap_button button_type="submit" content="Удалить" %}
          {% url 'variables:variable_by_plc' object.n_controller_id as cancel_url %}
          {% bootstrap_button button_type="link" href=cancel_url content="Отмена" %}
      
      {% endif %}
      
      {% if '/edit/' in request.path %}
      
      <button type="button" class="btn btn-outline-primary" id="btn_upload">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M18 9h-2c-.6 0-1 .4-1 1s.4 1 1 1h2c.6 0 1 .4 1 1v7c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-7c0-.6.4-1 1-1h2c.6 0 1-.4 1-1s-.4-1-1-1H6c-1.7 0-3 1.3-3 3v7c0 1.7 1.3 3 3 3h12c1.7 0 3-1.3 3-3v-7c0-1.7-1.3-3-3-3zM9.7 6.7L11 5.4V17c0 .6.4 1 1 1s1-.4 1-1V5.4l1.3 1.3c.2.2.4.3.7.3c.3 0 .5-.1.7-.3c.4-.4.4-1 0-1.4l-3-3c-.4-.4-1-.4-1.4 0l-3 3c-.4.4-.4 1 0 1.4c.4.4 1 .4 1.4 0z"/></svg>
      </button>    
      
      {% endif %}



        </form>
      </div>
    </div>
  </div>

<table id="tbl_id" name="tbl" class="not-visible">
    <thead>
      <tr>
        <th>Col</th>
      </tr>
    </thead>
  <tbody>
  </tbody>  
</table>
  

  {% comment %} <script>
    const signal_content = document.getElementById('signal_content');
    const sel_variable_type = document.getElementById('id_c_variable_type');
    $("#id_c_variable_type").on('change', function (e){
      e.preventDefault();
      console.log(signal_content)
      //pb.classList.remove("not-visible");
      signal_content.innerHTML = '<li class="list-group-item list-group-item-secondary">' + sel_variable_type.options[sel_variable_type.selectedIndex].text + '</li>'
      
  })

  </script>   {% endcomment %}
  {% comment %} <script async src="{% static 'js/create/create_object.js' %}"></script> {% endcomment %}
  <script>
    $("#view_detail").on('click', function (e){
      let btn = document.getElementById('tbl_id');
      /*if ("not-visible" in btn.classList)*/
      btn.classList.remove("not-visible");
      /*else*/
      /*btn.classList.add("not-visible");*/
    
    });
    //var type_for_paste = 'var';

    $(document).ready(function() {

      var mes_len = {{ view.kwargs.RETURN_BLOCK_FROM_PLC|length }};
      console.log(mes_len);
    
      if (mes_len > 0) {
        var mes_response = [];
    
        {% for item in view.kwargs.RETURN_BLOCK_FROM_PLC %}
    
        if (typeof "{{ item.error_num }}" !== 'undefined' && "{{ item.error_num }}" !== '') {
          mes_response.push("{{ item.error_num }}");
        }
        if (typeof "{{ item.index_num }}" !== 'undefined' && "{{ item.index_num }}" !== '' && "{{ item.index_num }}" !== 'None') {
          mes_response.push("{{ item.index_num }}");
        }
        if (typeof "{{ item.param_num }}" !== 'undefined' && "{{ item.param_num }}" !== '' && "{{ item.param_num }}" !== 'None') {
          mes_response.push("{{ item.param_num }}");
        }
    
        {% endfor %}
    
        alert(mes_response);
        console.log(mes_response);
      }

      var control_content = document.getElementById('control_buttons');
      console.log('start')

      /*$('#n_type_id').on('change', function(){
       // ShowRoles();
       console.log('change')
        
      });*/
      //control_content.innerHTML = '<button type="button" class="btn btn-outline-primary" id="id_test">Вставить</button>'
      control_content.innerHTML = '<li class="list-group-item d-flex justify-content-between align-items-center" id="id_line"> \
        <select name="select_type" id="id_select_type" class="form-select" arial-label="Default select" onchange="GetObjComboVal(this)"> \
            <option value="1">Переменная</option> \
            <option value="2">Оборудование</option> \
        </select> \
        <select name="object_list" id="id_object_list" class="form-select" arial-label="Default select"> \
            <option value="select_item" selected>Не выбран</option>                                \
            {% for item_var in form.variable_list %} \
                <option value={{ item_var.id }}>{{ item_var.c_name_variable }}</option> \
            {% endfor %} \
        </select> \
        <button type="button" id="button_paste" class="btn btn-primary" onclick="VarPaste()"> Вставить \
        </button> \
    </li>'

}); 
function VarPaste(){
  //alert('click')
  const delimeter = '_';
  var_content = document.getElementById('id_object_list');
  text_content = document.getElementById('id_attrtxt_Formula');
  var startPos = text_content.selectionStart;
  var endPos = text_content.selectionEnd;
  
  /*if (type_for_paste == 'var')
  {
    delimeter = 
  }
  else
  {}*/
  text_content.value = text_content.value.substring(0, startPos)
      + var_content.selectedIndex
      + text_content.value.substring(endPos, text_content.value.length);
  /*text_content.value = text_content.value.substring(0, startPos)
      + delimeter + var_content.options[var_content.selectedIndex].text
      + delimeter + text_content.value.substring(endPos, text_content.value.length);*/
  //text_content.value = text_content.value  + var_content.options[var_content.selectedIndex].text

  //var value = var_content.value;
  //var text = var_content.options[var_content.selectedIndex].text;
  //console.log(var_content.value)
  //console.log(var_content.options[var_content.selectedIndex].text)
  //elmnt.options[i].value
}

function GetObjComboVal(selectObject) {
  console.log("---");
  
  const obj_type = document.getElementById('id_select_type')
  const obj_list = document.getElementById('id_object_list')
  

  $("#id_object_list").empty();

  var n_obj_id;
  var c_obj_name;

  if (obj_type.options[obj_type.selectedIndex].text == 'Переменная')
  {

      //type_for_paste = 'var';
      n_obj_id = [
      {% for item in form.variable_list %}
      {{ item.id }},
      {% endfor %}
      ]
      c_obj_name = [
      {% for item in form.variable_list %}
      '{{ item.c_name_variable }}',
      {% endfor %}
      ]
  }
  else
  {
      //type_for_paste = 'eq';
      n_obj_id = [
      {% for item in form.equipment_list %}
      {{ item.id }},
      {% endfor %}
      ]
      c_obj_name = [
      {% for item in form.equipment_list %}
      '{{ item.c_desc_equipment }}',
      {% endfor %}
      ]
  }


  for(var i=0; i < n_obj_id.length; i++) 
  {
      if (i == 0)
      {
          var option = document.createElement("option");
          option.value = 'select_item'
          option.text = 'Не выбран';
          option.selected = true;
          obj_list.add(option)
      }

      var option = document.createElement("option");
      option.value = n_obj_id[i]
      option.text = c_obj_name[i];
      obj_list.add(option)
  }


}

$("#btn_download").on('click', function (e){
  e.preventDefault();
  $.ajax({
      url: "{% url 'variables:download_variables' view.kwargs.plc_id %}?min={{object.id}}&max={{object.id}}&action=download",     
      //url: "{% url 'modules:check_state' %}",
      //headers: {'X-CSRFToken': csrftoken},
      //data: {'search_input': search_input},
      type: "GET",
      //dataType: 'html',
      success: function (data) {
          if (data) {
              //console.log(data);
              console.log('выполнился success');
              console.log(data.error_back.length);
              if (Object.keys(data.error_back).length > 0)
                {
                  var messages = ['При загрузке возникли ошибки:\r\n\r\n'];

                      console.log(data.error_back)
                      
                      for (var x=0; x<data.error_back.length; x++)
                      {
                        console.log(data.error_back[x].error_num)
                        messages.push(data.error_back[x].error_num + ', ' + data.error_back[x].index_num + '\r\n\r\n')
                      }

                  alert(messages);
                }
              else
              {alert('Переменная успешно загружена в ПЛК');}
              //}             
              // Add the http response to element
              //target_element.html(data);
          }
      }
  });
});

$("#btn_upload").on('click', function (e){
  e.preventDefault();
  let btn = $(this);
  btn.attr("disabled", true);

  $.ajax({

      url: "{% url 'variables:upload_variables' view.kwargs.plc_id %}?min={{object.id}}&max={{object.id}}&action=upload",     

      type: "GET",

      success: function (data) {
          btn.attr("disabled", false);
          if (data) {
              console.log(data);
              console.log('выполнился success');
              if (data.return_block.length > 0)
              {
              var messages = ['Данные в БД и ПЛК не соответствуют по следующим позициям:\r\n\r\n'];

              console.log(data.return_block)
              //alert(data.error_back);                    
              for (var x=0; x<data.return_block.length; x++)
              {
                  console.log(data.return_block[x])
                  if (data.return_block[0] == 'Нет ответа от ПЛК!')
                  {
                    messages = ['Нет ответа от ПЛК!'];
                  }
                  else
                  {
                    messages.push(data.return_block[x] + '\r\n\r\n')
                  }
              }
              alert(messages);
              }
              else
              {alert('Данные в БД и ПЛК идентичны');}

              
          }
          
      }
    });
});





</script>       

{% endblock %}